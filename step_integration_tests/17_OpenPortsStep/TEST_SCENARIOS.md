# OpenPortsStep Integration Tests

## Purpose
Configure iptables firewall rules to open required ports for Kubernetes cluster operation.

## Step Overview
- **Execution Order**: Step 17
- **Commands Executed**:
  - `sudo iptables -C INPUT -p <protocol> -m state --state NEW -m <protocol> --dport <port> -j ACCEPT` (check rule)
  - `sudo iptables -A INPUT -p <protocol> -m state --state NEW -m <protocol> --dport <port> -j ACCEPT` (add rule)
  - `sudo iptables-save` (persist rules)
- **Skip Conditions**: Never skipped

## What This Step Does
1. Iterates through list of required ports and protocols
2. For each port/protocol combination:
   - Checks if iptables rule already exists (-C flag)
   - If rule exists, skips to next port
   - If rule doesn't exist, adds it (-A flag)
3. Saves all iptables rules to persist across reboots
4. Required ports list:
   - **80/tcp**: HTTP traffic
   - **443/tcp**: HTTPS traffic
   - **2376/tcp**: Docker daemon TLS
   - **2379/tcp**: etcd client
   - **2380/tcp**: etcd peer
   - **6443/tcp**: Kubernetes API server
   - **8472/udp**: Flannel VXLAN (if used)
   - **9099/tcp**: Calico BGP
   - **9345/tcp**: RKE2 supervisor
   - **10250/tcp**: Kubelet API
   - **10254/tcp**: Ingress controller
   - **30000-32767/tcp**: NodePort services (TCP)
   - **30000-32767/udp**: NodePort services (UDP)

## Test Scenarios

### Success Scenarios

#### 1. No Rules Exist - Add All Rules
Tests adding all firewall rules on fresh system.

#### 2. All Rules Already Exist - No Changes
Tests idempotent behavior when all rules already configured.

#### 3. Some Rules Exist - Add Missing Rules
Tests partial configuration where some ports are open, others aren't.

#### 4. Save Rules Successfully
Tests successful persistence of iptables rules.

### Failure Scenarios

#### 5. iptables -C Check Fails (Permission Denied)
Tests error handling when checking existing rules fails.

#### 6. iptables -A Add Rule Fails
Tests error handling when adding new rule fails.

#### 7. iptables-save Fails
Tests error handling when saving rules fails.

#### 8. Individual Port Rule Fails - Port 6443
Tests failure to open critical Kubernetes API port.

## Configuration Requirements

- `ENABLED_STEPS: "OpenPortsStep"`
- No specific configuration required
- Port list is hardcoded in `pkg/os-setup.go`

## Mock Requirements

```yaml
mocks:
  # Scenario 1: No rules exist - add all
  # Check rules (all return error = doesn't exist)
  "OpenPorts.CheckRule":
    output: ""
    error: "iptables: Bad rule (does a matching rule exist in that chain?)."

  # Add all rules (one for each port)
  "OpenPorts.AddRule":
    output: ""
    error: null

  # Save rules
  "OpenPorts.SaveRules":
    output: |
      # Generated by iptables-save
      *filter
      :INPUT ACCEPT [0:0]
      :FORWARD ACCEPT [0:0]
      :OUTPUT ACCEPT [0:0]
      -A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
      -A INPUT -p tcp -m state --state NEW -m tcp --dport 443 -j ACCEPT
      ...
      COMMIT
    error: null

  # Scenario 2: All rules exist
  "OpenPorts.CheckRule":
    output: ""
    error: null  # Success = rule exists
  # No AddRule calls
  "OpenPorts.SaveRules":
    output: ""
    error: null

  # Scenario 6: Add rule fails
  "OpenPorts.CheckRule":
    output: ""
    error: "iptables: Bad rule (does a matching rule exist in that chain?)."

  "OpenPorts.AddRule":
    output: ""
    error: "iptables: Permission denied (you must be root)."

  # Scenario 7: Save fails
  "OpenPorts.SaveRules":
    output: ""
    error: "Can't open /etc/iptables/rules.v4: Permission denied"
```

## Running Tests

```bash
# Test 1: No rules exist
./cluster-bloom cli --config step_integration_tests/17_OpenPortsStep/01-no-rules-exist/config.yaml \
                    --dry-run \
                    --dry-run-mocks step_integration_tests/17_OpenPortsStep/01-no-rules-exist/mocks.yaml

# Test 2: Rules exist
./cluster-bloom cli --config step_integration_tests/17_OpenPortsStep/02-rules-exist/config.yaml \
                    --dry-run \
                    --dry-run-mocks step_integration_tests/17_OpenPortsStep/02-rules-exist/mocks.yaml

# Test 6: Add rule fails
./cluster-bloom cli --config step_integration_tests/17_OpenPortsStep/06-add-rule-fails/config.yaml \
                    --dry-run \
                    --dry-run-mocks step_integration_tests/17_OpenPortsStep/06-add-rule-fails/mocks.yaml
```

## Expected Outcomes

### Success Cases
- ✅ All required ports opened in iptables
- ✅ Rules checked before adding (avoid duplicates)
- ✅ Existing rules preserved
- ✅ Rules saved and persisted
- ✅ Step completes successfully

### Failure Cases
- ❌ iptables check failure stops execution
- ❌ iptables add failure stops execution
- ❌ iptables-save failure stops execution
- ❌ Error indicates which port failed

## Related Code
- Step implementation: `pkg/steps.go:528-537`
- Main function: `pkg/os-setup.go:OpenPorts()`
- Port list: `pkg/os-setup.go:ports` variable (array of "port;protocol" strings)
- Total ports: 13 distinct rules (11 TCP, 2 UDP, 2 range rules)

## Notes
- **Port 80**: HTTP ingress traffic
- **Port 443**: HTTPS ingress traffic (most common)
- **Port 2376**: Docker daemon remote API (TLS)
- **Port 2379/2380**: etcd distributed key-value store
- **Port 6443**: Kubernetes API server (critical!)
- **Port 8472**: Flannel overlay network (UDP)
- **Port 9099**: Calico BGP routing
- **Port 9345**: RKE2 supervisor port
- **Port 10250**: Kubelet API for metrics, logs, exec
- **Port 10254**: Ingress controller health checks
- **Port range 30000-32767**: NodePort service range (configurable in K8s)
- **SSH (port 22)**: Explicitly excluded from script (assumed required)
- **iptables -C**: Check flag returns 0 if rule exists, non-zero if not
- **iptables -A**: Append flag adds rule to end of chain
- **iptables-save**: Writes current rules to stdout (typically piped to file)
- **Idempotent**: Checks before adding, safe to run multiple times
- **State tracking**: Uses connection state NEW to only match new connections
- **Persistence**: iptables rules are ephemeral without iptables-save/restore
- **Alternative**: Some systems use ufw (Uncomplicated Firewall) instead
- **RKE2 requirement**: All these ports required for proper cluster operation
- **Security note**: Opens wide NodePort range - consider restricting in production
