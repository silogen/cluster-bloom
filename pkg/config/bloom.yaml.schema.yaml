# YAML Schema (Kwalify/Yamale-style) for bloom.yaml
# This uses YAML-native type definitions instead of JSON Schema
# Schema Version: 2.0.0-alt
# Last Updated: 2025-12-10

# ========================================
# Schema Definition
# ========================================

schema:
  type: map
  mapping:
    # üìã Basic Configuration
    FIRST_NODE:
      type: bool
      default: true
      desc: Set to true if this is the first node in the cluster
      section: "üìã Basic Configuration"

    GPU_NODE:
      type: bool
      default: true
      desc: Set to true if this node has GPUs
      section: "üìã Basic Configuration"

    DOMAIN:
      type: domain
      desc: The domain name for the cluster (required for first node)
      required: when(FIRST_NODE == true)
      section: "üìã Basic Configuration"
      examples:
        - "cluster.example.com"
        - "k8s.internal.company.com"

    CLUSTER_SIZE:
      type: enum
      values: [small, medium, large]
      default: medium
      desc: Size category for cluster deployment planning
      section: "üìã Basic Configuration"

    # üîó Additional Node Configuration
    SERVER_IP:
      type: ipv4
      desc: IP address of the RKE2 server
      required: when(FIRST_NODE == false)
      section: "üîó Additional Node Configuration"

    JOIN_TOKEN:
      type: str
      desc: Token for joining additional nodes
      required: when(FIRST_NODE == false)
      section: "üîó Additional Node Configuration"

    CONTROL_PLANE:
      type: bool
      default: false
      desc: Control plane node (only when FIRST_NODE=false)
      applicable: when(FIRST_NODE == false)
      section: "üîó Additional Node Configuration"

    # üíæ Storage Configuration
    NO_DISKS_FOR_CLUSTER:
      type: bool
      default: false
      desc: Skip all disk-related operations
      section: "üíæ Storage Configuration"

    CLUSTER_DISKS:
      type: devicePath
      default: ""
      desc: Comma-separated list of disk device paths
      section: "üíæ Storage Configuration"

    CLUSTER_PREMOUNTED_DISKS:
      type: diskList
      default: ""
      desc: Comma-separated list of premounted disk paths
      section: "üíæ Storage Configuration"

    SKIP_RANCHER_PARTITION_CHECK:
      type: bool
      default: false
      desc: Skip /var/lib/rancher partition size check
      section: "üíæ Storage Configuration"

    # üîí SSL/TLS Configuration
    ADDITIONAL_TLS_SAN_URLS:
      type: seq
      default: []
      desc: Additional TLS Subject Alternative Name URLs for API server certificate
      applicable: when(FIRST_NODE == true)
      section: "üîí SSL/TLS Configuration"
      sequence:
        - type: str
          pattern: "^[a-z0-9]([a-z0-9-]*[a-z0-9])?(\\.([a-z0-9]([a-z0-9-]*[a-z0-9])?))*$"
          pattern-title: "Enter a valid domain name (lowercase alphanumeric with dots/hyphens)"

    USE_CERT_MANAGER:
      type: bool
      default: false
      desc: Use cert-manager with Let's Encrypt
      applicable: when(FIRST_NODE == true)
      section: "üîí SSL/TLS Configuration"

    CERT_OPTION:
      type: enum
      values: [existing, generate]
      desc: Certificate option when USE_CERT_MANAGER is false
      required: when(USE_CERT_MANAGER == false && FIRST_NODE == true)
      section: "üîí SSL/TLS Configuration"

    TLS_CERT:
      type: certFilePath
      default: ""
      desc: Path to TLS certificate file
      required: when(CERT_OPTION == existing)
      section: "üîí SSL/TLS Configuration"

    TLS_KEY:
      type: keyFilePath
      default: ""
      desc: Path to TLS private key file
      required: when(CERT_OPTION == existing)
      section: "üîí SSL/TLS Configuration"

    # ‚öôÔ∏è Advanced Configuration
    ROCM_BASE_URL:
      type: url
      default: https://repo.radeon.com/amdgpu-install/7.0.2/ubuntu/
      desc: ROCm base repository URL
      applicable: when(GPU_NODE == true)
      section: "‚öôÔ∏è Advanced Configuration"

    ROCM_DEB_PACKAGE:
      type: str
      default: amdgpu-install_7.0.2.70002-1_all.deb
      desc: ROCm DEB package name
      applicable: when(GPU_NODE == true)
      section: "‚öôÔ∏è Advanced Configuration"

    CLUSTERFORGE_RELEASE:
      type: str
      default: https://github.com/silogen/cluster-forge/releases/download/v1.8.0/release-enterprise-ai-v1.8.0.tar.gz
      desc: ClusterForge version URL or 'none'
      section: "‚öôÔ∏è Advanced Configuration"

    CF_VALUES:
      type: str
      default: ""
      desc: Path to ClusterForge values file
      section: "‚öôÔ∏è Advanced Configuration"

    ADDITIONAL_OIDC_PROVIDERS:
      type: seq
      default: []
      desc: Additional OIDC providers
      section: "‚öôÔ∏è Advanced Configuration"
      sequence:
        - type: map
          mapping:
            url:
              type: str
            audiences:
              type: seq
              sequence:
                - type: str

    PRELOAD_IMAGES:
      type: str
      default: docker.io/rocm/pytorch:rocm6.4_ubuntu24.04_py3.12_pytorch_release_2.6.0,docker.io/rocm/vllm:rocm6.4.1_vllm_0.9.0.1_20250605
      desc: Comma-separated list of container images to preload
      section: "‚öôÔ∏è Advanced Configuration"

    RKE2_INSTALLATION_URL:
      type: url
      default: https://get.rke2.io
      desc: RKE2 installation script URL
      section: "‚öôÔ∏è Advanced Configuration"

    RKE2_VERSION:
      type: rke2Version
      default: v1.34.1+rke2r1
      desc: Specific RKE2 version to install
      section: "‚öôÔ∏è Advanced Configuration"

    RKE2_EXTRA_CONFIG:
      type: str
      default: ""
      desc: Additional RKE2 configuration in YAML format
      section: "‚öôÔ∏è Advanced Configuration"

    # üíª Command Line Options
    DISABLED_STEPS:
      type: str
      default: ""
      desc: Comma-separated list of step names to skip
      section: "üíª Command Line Options"

    ENABLED_STEPS:
      type: str
      default: ""
      desc: Comma-separated list of steps to run
      section: "üíª Command Line Options"

# ========================================
# Type Definitions
# ========================================

types:
  domain:
    type: str
    pattern: ^([a-z0-9]([\-a-z0-9]*[a-z0-9])?\.)*[a-z0-9]([\-a-z0-9]*[a-z0-9])?$
    desc: Valid DNS domain name (lowercase alphanumeric with dots/hyphens)
    errorMessage: Domain must be lowercase alphanumeric with dots/hyphens (e.g., example.com or sub.example.com). Cannot start/end with hyphen or dot, no special characters.
    examples:
      valid:
        - "example.com"
        - "cluster.example.com"
        - "k8s.internal.company.com"
        - "ai-cluster.local"
        - "a.b.c.d.e.f.g"
        - "test-domain.com"
        - "test123.com"
        - "a"
        - "example-123.test-456.com"
      invalid:
        - ""                         # empty
        - "Example.com"               # uppercase
        - "CLUSTER.EXAMPLE.COM"       # uppercase
        - "-example.com"              # starts with hyphen
        - "example-.com"              # ends with hyphen
        - "example..com"              # double dot
        - ".example.com"              # starts with dot
        - "example.com."              # ends with dot
        - "example_test.com"          # underscore
        - "example com"               # space
        - "example.com/path"          # path
        - "https://example.com"       # URL
        - "user@example.com"          # email
  domainList:
    type: str
    pattern: ^([a-z0-9]([\-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([\-a-z0-9]*[a-z0-9])?)*)(\s*,\s*[a-z0-9]([\-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([\-a-z0-9]*[a-z0-9])?)*)*$|^$
    desc: Comma-separated list of domain names (each matching domain type)
    errorMessage: Enter comma-separated domain names (lowercase alphanumeric with dots/hyphens)
    examples:
      valid:
        - "example.com"
        - "api.example.com, kubernetes.example.com"
        - "api.example.com,kubernetes.example.com"
        - "a.com, b.com, c.com"
        - "test-1.com, test-2.org"
      invalid:
        - "Example.com"                   # uppercase
        - "example.com, Example.com"      # uppercase in second
        - "example.com,"                  # trailing comma
        - ",example.com"                  # leading comma
        - "example.com,,test.com"         # double comma
        - "example_test.com"              # underscore
        - "example.com, https://test.com" # URL in list

  ipv4:
    type: str
    pattern: ^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^$
    desc: Valid IPv4 address
    errorMessage: Valid IPv4 address format xxx.xxx.xxx.xxx (0-255 for each octet)
    examples:
      valid:
        - "10.100.100.11"
        - "192.168.1.100"
        - "0.0.0.0"
        - "255.255.255.255"
        - "127.0.0.1"
        - "172.16.0.1"
        - "1.2.3.4"
      invalid:
        - "256.0.0.1"       # out of range
        - "1.256.0.1"       # out of range
        - "1.2.256.1"       # out of range
        - "1.2.3.256"       # out of range
        - "1.2.3"           # incomplete
        - "1.2.3.4.5"       # too many octets
        - "a.b.c.d"         # letters
        - "192.168.1"       # incomplete
        - "192.168.1.1/24"  # CIDR notation
        - "example.com"     # domain

  url:
    type: str
    pattern: https?://.+
    desc: Valid HTTP or HTTPS URL
    errorMessage: Enter a valid URL starting with http:// or https://
    examples:
      valid:
        - "https://example.com"
        - "http://example.com"
        - "https://repo.radeon.com/amdgpu-install/7.0.2/ubuntu/"
        - "https://get.rke2.io"
        - "https://github.com/silogen/cluster-forge/releases/download/v1.5.2/release.tar.gz"
        - "http://localhost:8080"
        - "https://api.example.com/v1/resource"
      invalid:
        - ""                  # empty
        - "example.com"         # missing protocol
        - "ftp://example.com"   # FTP not allowed
        - "//example.com"       # protocol-relative
        - "www.example.com"     # missing protocol
        - "/path/to/file"       # local path
  devicePath:
    type: str
    pattern: ^(/dev/[a-zA-Z0-9]+)(,/dev/[a-zA-Z0-9]+)*$|^$
    desc: Comma-separated Linux device paths
    errorMessage: Enter comma-separated device paths like /dev/nvme0n1,/dev/nvme1n1
    examples:
      valid:
        - "/dev/nvme0n1"
        - "/dev/nvme0n1,/dev/nvme1n1"
        - "/dev/sda,/dev/sdb,/dev/sdc"
        - "/dev/nvme0n1,/dev/sda"
        - "/dev/vda"
        - "/dev/sda1"
      invalid:
        - "nvme0n1"                   # missing /dev
        - "/dev/"                     # incomplete
        - "/dev/nvme0n1,"             # trailing comma
        - ",/dev/nvme0n1"             # leading comma
        - "/dev/nvme-0-n1"            # hyphen not allowed
        - "/dev/nvme0n1, /dev/sda"    # space after comma
        - "/dev/nvme0n1 /dev/sda"     # space separator
        - "/dev/nvme_0"               # underscore not allowed
        - "/mnt/disk1"                # not /dev path

  diskList:
    type: str
    pattern: ^(/[a-zA-Z0-9._\-\/]+)(,/[a-zA-Z0-9._\-\/]+)*$|^$
    desc: Comma-separated absolute paths to premounted disks
    errorMessage: Enter comma-separated absolute paths like /mnt/disk1,/mnt/disk2
    examples:
      valid:
        - "/mnt/disk1"
        - "/mnt/disk1,/mnt/disk2,/mnt/disk3"
        - "/mnt/disk1,/mnt/disk2"
        - "/data/disk1"
        - "/storage/disk01"
        - "/mnt/storage-01"
        - "/mnt/my_disk"
        - "/mnt/disk.1"
      invalid:
        - "disk1"            # not absolute path
        - "disk1,disk2"      # not absolute paths
        - "/mnt/disk1,"      # trailing comma
        - ",/mnt/disk1"      # leading comma
        - "/mnt/disk1, /mnt/disk2"   # space after comma
        - "/mnt/disk1 /mnt/disk2"    # space separator
        - "mnt/disk1"        # missing leading slash

  certFilePath:
    type: str
    pattern: ^(/[\-a-zA-Z0-9._]+)+\.(pem|crt|cert)$|^$
    desc: Absolute path to certificate file
    errorMessage: Certificate file must be an absolute path ending with .pem, .crt, or .cert
    examples:
      valid:
        - "/etc/ssl/certs/cluster.crt"
        - "/home/user/certs/tls.pem"
        - "/opt/cert.cert"
        - "/a.pem"
        - "/path/to/my-cert.pem"
        - "/path/to/my_cert.crt"
        - "/path.with.dots/cert.pem"
      invalid:
        - "cert.pem"                   # not absolute path
        - "/path/to/cert.key"          # wrong extension
        - "/path/to/cert.txt"          # wrong extension
        - "/path/to/cert"              # no extension
        - "/path/to/cert.PEM"          # uppercase extension
        - "relative/path/cert.pem"     # relative path
        - "/path with spaces/cert.pem" # spaces not allowed
        - "/path/cert@special.pem"     # special char not allowed

  keyFilePath:
    type: str
    pattern: ^(/[\-a-zA-Z0-9._]+)+\.(pem|key)$|^$
    desc: Absolute path to private key file
    errorMessage: Key file must be an absolute path ending with .pem or .key
    examples:
      valid:
        - "/etc/ssl/private/cluster.key"
        - "/home/user/certs/tls-key.pem"
        - "/opt/key.key"
        - "/a.pem"
        - "/path/to/my-key.key"
        - "/path/to/my_key.pem"
      invalid:
        - "key.pem"                    # not absolute path
        - "/path/to/key.crt"           # wrong extension
        - "/path/to/key.txt"           # wrong extension
        - "/path/to/key"               # no extension
        - "/path/to/key.KEY"           # uppercase extension
        - "relative/path/key.pem"      # relative path
        - "/path with spaces/key.pem"  # spaces not allowed

  rke2Version:
    type: str
    pattern: ^v[0-9]+\.[0-9]+\.[0-9]+(\+rke2r[0-9]+)?$|^$
    desc: RKE2 version format
    errorMessage: Version must be in format v1.2.3 or v1.2.3+rke2r1
    examples:
      valid:
        - "v1.34.1+rke2r1"
        - "v1.33.0+rke2r1"
        - "v1.0.0"
        - "v2.5.10+rke2r99"
        - "v0.0.1"
      invalid:
        - "1.34.1"              # missing v prefix
        - "v1.34"               # incomplete version
        - "v1"                  # incomplete version
        - "V1.34.1+rke2r1"      # uppercase V
        - "v1.34.1+rke2"        # missing r number
        - "v1.34.1+rke2r"       # missing r number
        - "v1.34.1-rke2r1"      # wrong separator
        - "v1.34.1.0"           # too many parts
        - "v1.34.a"             # letter in version
        - "latest"              # string version

# ========================================
# Validation Rules
# ========================================

constraints:
  - mutually_exclusive: [DISABLED_STEPS, ENABLED_STEPS]

  # Storage configuration - exactly one must be configured
  - one_of:
      - NO_DISKS_FOR_CLUSTER
      - CLUSTER_DISKS
      - CLUSTER_PREMOUNTED_DISKS
    error: "Exactly one storage option must be configured: NO_DISKS_FOR_CLUSTER=true OR CLUSTER_DISKS OR CLUSTER_PREMOUNTED_DISKS"
