---
# RKE2 First Node Setup
# 
# Installs and configures RKE2 server on the first cluster node.
# This node becomes the initial control plane and establishes the cluster.
#
# Prerequisites:
# - RKE2 configuration file must be present at /etc/rancher/rke2/config.yaml
# - Node labels and cluster configuration should be set up
#
# Conditional: FIRST_NODE
# Tags: rke2, deploy_cluster

- name: Install RKE2 server
  shell: curl -sfL {{ rke2_installation_url }} | sh -
  args:
    creates: /usr/local/bin/rke2
  when: not ansible_check_mode

- name: Debug RKE2 installation (check mode)
  debug:
    msg: "Would install RKE2 server from {{ rke2_installation_url }}"
  when: ansible_check_mode

- name: Enable RKE2 server service
  service:
    name: rke2-server
    enabled: yes
  when: not ansible_check_mode

- name: Debug RKE2 service enable (check mode)
  debug:
    msg: "Would enable rke2-server service"
  when: ansible_check_mode

- name: Start RKE2 server service
  shell: systemctl start rke2-server
  register: rke2_start
  failed_when: false
  changed_when: rke2_start.rc == 0
  when: not ansible_check_mode

- name: Fail if RKE2 server failed to start
  fail:
    msg: >-
      RKE2 server failed to start. Check with: journalctl -xeu rke2-server.service
      stderr: {{ rke2_start.stderr | default('') }}
  when: not ansible_check_mode and rke2_start is defined and rke2_start.rc != 0

- name: Debug RKE2 service start (check mode)
  debug:
    msg: "Would start rke2-server service"
  when: ansible_check_mode

- name: Wait for RKE2 to be ready
  wait_for:
    path: /var/lib/rancher/rke2/server/node-token
    state: present
    timeout: 300
  when: not ansible_check_mode

- name: Debug RKE2 readiness wait (check mode)
  debug:
    msg: "Would wait for RKE2 node token at /var/lib/rancher/rke2/server/node-token"
  when: ansible_check_mode