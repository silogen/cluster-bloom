---
# Deploy Cluster Tasks - Main Orchestrator
# 
# This file orchestrates all cluster deployment tasks including:
# 1. Node label configuration
# 2. Kubernetes tools installation  
# 3. Log rotation setup
# 4. RKE2 installation and configuration
# 5. KubeConfig setup
# 6. Join command generation
#
# All tasks maintain their original conditional logic and tags.
#
# Stage: deploy_cluster

- name: Prepare RKE2
  tags: [rke2, deploy_cluster]
  block:
    - include_tasks: prepare_rke2.yml

- name: Generate Node Labels
  tags: [rke2, deploy_cluster]
  block:
    - include_tasks: node_labels.yml

- name: Install Kubernetes Tools  
  tags: [tools, deploy_cluster]
  block:
    - include_tasks: k8s_tools.yml

- name: Configure logrotate
  tags: [logging, deploy_cluster]
  block:
    - include_tasks: logrotate.yml

- name: Setup RKE2 (First Node)
  tags: [rke2, deploy_cluster]
  when: FIRST_NODE | bool
  block:
    - include_tasks: rke2_first_node.yml

- name: Setup RKE2 (Additional Node - Worker)
  tags: [rke2, deploy_cluster]
  when: not FIRST_NODE | bool and not CONTROL_PLANE | bool
  block:
    - include_tasks: rke2_worker.yml

- name: Setup RKE2 (Additional Node - Control Plane)
  tags: [rke2, deploy_cluster]
  when: not FIRST_NODE | bool and CONTROL_PLANE | bool
  block:
    - include_tasks: rke2_control_plane.yml

- name: Setup KubeConfig (Control Plane Nodes)
  tags: [kubeconfig, deploy_cluster]
  when: FIRST_NODE | bool or CONTROL_PLANE | bool
  block:
    - include_tasks: kubeconfig.yml

- name: Generate Join Command (First Node)
  tags: [output, deploy_cluster]
  when: FIRST_NODE | bool
  block:
    - include_tasks: join_command.yml