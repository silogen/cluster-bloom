---
# RKE2 Additional Control Plane Node Setup
# 
# Installs and configures RKE2 server on additional control plane nodes.
# These nodes join the cluster and participate in control plane operations
# for high availability.
#
# Prerequisites:
# - Existing RKE2 cluster with first node initialized
# - JOIN_TOKEN and SERVER_IP variables must be set
# - RKE2 configuration file must be present
#
# Conditional: not FIRST_NODE and CONTROL_PLANE
# Tags: rke2, deploy_cluster

- name: Add server and token to RKE2 config
  blockinfile:
    path: /etc/rancher/rke2/config.yaml
    block: |
      server: https://{{ SERVER_IP }}:9345
      token: {{ JOIN_TOKEN }}
    marker: "# {mark} ANSIBLE MANAGED BLOCK - join config"
    create: yes
    mode: "0644"
  when: not ansible_check_mode

- name: Debug RKE2 control plane join config (check mode)
  debug:
    msg: "Would configure RKE2 control plane to join cluster at https://{{ SERVER_IP }}:9345"
  when: ansible_check_mode

- name: Create RKE2 registries.yaml
  copy:
    content: |
      docker.io:
      ghcr.io:
      quay.io:
    dest: /etc/rancher/rke2/registries.yaml
    mode: "0644"

- name: Install RKE2 server (control plane)
  shell: curl -sfL {{ rke2_installation_url }} | INSTALL_RKE2_TYPE=server sh -
  args:
    creates: /usr/local/bin/rke2
  when: not ansible_check_mode

- name: Debug RKE2 server installation (check mode)
  debug:
    msg: "Would install RKE2 server from {{ rke2_installation_url }}"
  when: ansible_check_mode

- name: Enable RKE2 server service
  service:
    name: rke2-server
    enabled: yes
  when: not ansible_check_mode

- name: Debug RKE2 server enable (check mode)
  debug:
    msg: "Would enable rke2-server service"
  when: ansible_check_mode

- name: Start RKE2 server service
  service:
    name: rke2-server
    state: started
  when: not ansible_check_mode

- name: Debug RKE2 server start (check mode)
  debug:
    msg: "Would start rke2-server service"
  when: ansible_check_mode