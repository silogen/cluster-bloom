---
# Generate Join Command for Additional Nodes
# 
# Creates join commands and instructions for adding additional nodes to the cluster.
# Extracts the join token and provides formatted commands for future node additions.
#
# Prerequisites:
# - RKE2 first node must be running
# - Node token must be available at /var/lib/rancher/rke2/server/node-token
# - BLOOM_DIR variable must be set
#
# Conditional: FIRST_NODE
# Tags: output, deploy_cluster

- name: Get join token
  slurp:
    src: /var/lib/rancher/rke2/server/node-token
  register: JOIN_TOKEN_content
  when: not ansible_check_mode

- name: Debug join token retrieval (check mode)
  debug:
    msg: "Would retrieve join token from /var/lib/rancher/rke2/server/node-token"
  when: ansible_check_mode

- name: Create additional node command file
  copy:
    content: |
      echo -e 'FIRST_NODE: false\nJOIN_TOKEN: {{ JOIN_TOKEN_content.content | b64decode | trim }}\nSERVER_IP: {{ node_ip }}' > bloom.yaml && sudo ./bloom --config bloom.yaml
    dest: "{{ BLOOM_DIR }}/additional_node_command.txt"
    mode: "0644"
  become: no
  when: not ansible_check_mode

- name: Debug command file creation (check mode)
  debug:
    msg: "Would create additional node command file at {{ BLOOM_DIR }}/additional_node_command.txt"
  when: ansible_check_mode

- name: Display join information
  debug:
    msg: |
      ============================================
      Cluster setup complete!

      Join Token: {{ JOIN_TOKEN_content.content | b64decode | trim }}
      Server IP: {{ node_ip }}

      To add additional nodes, use:
      ansible-playbook cluster-bloom.yaml -e "FIRST_NODE=false SERVER_IP={{ node_ip }} JOIN_TOKEN={{ JOIN_TOKEN_content.content | b64decode | trim }}"
      ============================================
  when: not ansible_check_mode

- name: Display join information (check mode)
  debug:
    msg: |
      ============================================
      CHECK MODE: Would display cluster setup completion information
      Server IP: {{ node_ip }}
      Would create join token and additional node commands
      ============================================
  when: ansible_check_mode