---
# KubeConfig Setup for Control Plane Nodes
# 
# Sets up kubectl configuration for accessing the Kubernetes cluster.
# Configures kubeconfig for both root and sudo users, and sets up
# PATH variables for k9s tool access.
#
# Prerequisites:
# - RKE2 must be running and kubeconfig available at /etc/rancher/rke2/rke2.yaml
# - Node IP must be configured for external access
#
# Conditional: FIRST_NODE or CONTROL_PLANE
# Tags: kubeconfig, deploy_cluster

- name: Wait for RKE2 kubeconfig to be available
  wait_for:
    path: /etc/rancher/rke2/rke2.yaml
    state: present
    timeout: 300
  when: not ansible_check_mode

- name: Debug kubeconfig availability (check mode)
  debug:
    msg: "Would wait for RKE2 kubeconfig at /etc/rancher/rke2/rke2.yaml"
  when: ansible_check_mode

# Get home directories using getent
- name: Get root home directory
  shell: "getent passwd root | cut -d: -f6"
  register: root_home
  changed_when: false

- name: Get sudo user home directory
  shell: "getent passwd '{{ ansible_env.SUDO_USER }}' | cut -d: -f6"
  register: sudo_user_home
  changed_when: false
  when: ansible_env.SUDO_USER is defined and ansible_env.SUDO_USER != ""

# Create kubeconfig for root user
- name: Create .kube directory for root
  file:
    path: "{{ root_home.stdout }}/.kube"
    state: directory
    mode: "0755"
    owner: root
    group: root

- name: Copy kubeconfig for root user
  copy:
    src: /etc/rancher/rke2/rke2.yaml
    dest: "{{ root_home.stdout }}/.kube/config"
    remote_src: yes
    mode: "0600"
    owner: root
    group: root
  when: not ansible_check_mode

- name: Debug kubeconfig copy for root (check mode)
  debug:
    msg: "Would copy kubeconfig to {{ root_home.stdout }}/.kube/config for root user"
  when: ansible_check_mode

- name: Update server IP in root kubeconfig
  replace:
    path: "{{ root_home.stdout }}/.kube/config"
    regexp: '127\.0\.0\.1'
    replace: "{{ node_ip }}"
  when: not ansible_check_mode

- name: Debug server IP update for root kubeconfig (check mode)
  debug:
    msg: "Would update server IP to {{ node_ip }} in root kubeconfig"
  when: ansible_check_mode

# Create kubeconfig for sudo user (if exists)
- name: Create .kube directory for sudo user
  file:
    path: "{{ sudo_user_home.stdout }}/.kube"
    state: directory
    mode: "0755"
    owner: "{{ ansible_env.SUDO_USER }}"
    group: "{{ ansible_env.SUDO_USER }}"
  when: ansible_env.SUDO_USER is defined and ansible_env.SUDO_USER != ""

- name: Copy kubeconfig for sudo user
  copy:
    src: /etc/rancher/rke2/rke2.yaml
    dest: "{{ sudo_user_home.stdout }}/.kube/config"
    remote_src: yes
    mode: "0600"
    owner: "{{ ansible_env.SUDO_USER }}"
    group: "{{ ansible_env.SUDO_USER }}"
  when: ansible_env.SUDO_USER is defined and ansible_env.SUDO_USER != "" and not ansible_check_mode

- name: Debug kubeconfig copy for sudo user (check mode)
  debug:
    msg: "Would copy kubeconfig to {{ sudo_user_home.stdout }}/.kube/config for {{ ansible_env.SUDO_USER }}"
  when: ansible_env.SUDO_USER is defined and ansible_env.SUDO_USER != "" and ansible_check_mode

- name: Update server IP in sudo user kubeconfig
  replace:
    path: "{{ sudo_user_home.stdout }}/.kube/config"
    regexp: '127\.0\.0\.1'
    replace: "{{ node_ip }}"
  when: ansible_env.SUDO_USER is defined and ansible_env.SUDO_USER != "" and not ansible_check_mode

- name: Debug server IP update for sudo user kubeconfig (check mode)
  debug:
    msg: "Would update server IP to {{ node_ip }} in {{ ansible_env.SUDO_USER }} kubeconfig"
  when: ansible_env.SUDO_USER is defined and ansible_env.SUDO_USER != "" and ansible_check_mode

# Update PATH for k9s - root user
- name: Update PATH in bash_profile for k9s (root)
  lineinfile:
    path: "{{ root_home.stdout }}/.bash_profile"
    line: "export PATH=$PATH:/snap/k9s/current/bin"
    create: yes
    owner: root
    group: root
    mode: "0644"

- name: Update PATH in bashrc for k9s (root)
  lineinfile:
    path: "{{ root_home.stdout }}/.bashrc"
    line: "export PATH=$PATH:/snap/k9s/current/bin"
    create: yes
    owner: root
    group: root
    mode: "0644"

# Update PATH for k9s - sudo user
- name: Update PATH in bash_profile for k9s (sudo user)
  lineinfile:
    path: "{{ sudo_user_home.stdout }}/.bash_profile"
    line: "export PATH=$PATH:/snap/k9s/current/bin"
    create: yes
    owner: "{{ ansible_env.SUDO_USER }}"
    group: "{{ ansible_env.SUDO_USER }}"
    mode: "0644"
  when: ansible_env.SUDO_USER is defined and ansible_env.SUDO_USER != ""

- name: Update PATH in bashrc for k9s (sudo user)
  lineinfile:
    path: "{{ sudo_user_home.stdout }}/.bashrc"
    line: "export PATH=$PATH:/snap/k9s/current/bin"
    create: yes
    owner: "{{ ansible_env.SUDO_USER }}"
    group: "{{ ansible_env.SUDO_USER }}"
    mode: "0644"
  when: ansible_env.SUDO_USER is defined and ansible_env.SUDO_USER != ""