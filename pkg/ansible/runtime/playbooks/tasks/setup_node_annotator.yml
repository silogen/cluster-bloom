---
# Node Annotator Setup Tasks for All Clusters
# Independent of storage configuration and cluster size
# Handles GPU labeling and dynamic disk configuration for all nodes

- name: Deploy Node Annotator Manifests
  block:
    - name: Copy Node Annotator manifest
      copy:
        src: "manifests/longhorn/node-annotator.yaml"
        dest: "/var/lib/rancher/rke2/server/manifests/node-annotator.yaml"
        mode: "0644"

    - name: Wait for node annotator cronjob
      shell: |
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml \
          wait --for=create --timeout=600s cronjob/label-and-annotate-nodes -n default
      register: cronjob_wait
      retries: 3
      delay: 10
      failed_when: false

    - name: Trigger initial node annotation
      shell: |
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml \
          create job --from=cronjob/label-and-annotate-nodes \
          label-and-annotate-nodes-initial -n default
      register: initial_job
      failed_when: false

    - name: Wait for initial node annotation to complete
      shell: |
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml \
          wait --for=condition=complete --timeout=300s \
          job/label-and-annotate-nodes-initial -n default
      register: annotation_wait
      retries: 3
      delay: 10
      failed_when: false
      when: initial_job.rc == 0
      
    - name: Log Node Annotator success
      debug:
        msg: "Node annotator deployed and initial annotation completed for all cluster nodes"
      when: annotation_wait.rc == 0

    - name: Log Node Annotator warning
      debug:
        msg: "Node annotator deployed but initial annotation had issues - CronJob will retry every 5 minutes"
      when: annotation_wait.rc != 0