---
# Node Annotator Setup Tasks for All Clusters
# Independent of storage configuration and cluster size
# Handles GPU labeling and dynamic disk configuration for all nodes

- name: Deploy Node Annotator Manifests
  block:
    - name: Copy Node Annotator manifest
      copy:
        src: "manifests/longhorn/node-annotator.yaml"
        dest: "/var/lib/rancher/rke2/server/manifests/node-annotator.yaml"
        mode: "0644"
      when: not ansible_check_mode

    - name: Debug Node Annotator deployment (check mode)
      debug:
        msg: "Would copy Node Annotator manifest to /var/lib/rancher/rke2/server/manifests/node-annotator.yaml"
      when: ansible_check_mode

    - name: Wait for node annotator cronjob
      shell: |
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml \
          wait --for=create --timeout=600s cronjob/label-and-annotate-nodes -n default
      register: cronjob_wait
      retries: 3
      delay: 10
      failed_when: false
      when: not ansible_check_mode

    - name: Debug kubectl wait for cronjob (check mode)
      debug:
        msg: "Would wait for node annotator cronjob/label-and-annotate-nodes to be created"
      when: ansible_check_mode

    - name: Trigger initial node annotation
      shell: |
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml \
          create job --from=cronjob/label-and-annotate-nodes \
          label-and-annotate-nodes-initial -n default
      register: initial_job
      failed_when: false
      when: not ansible_check_mode

    - name: Debug kubectl create job (check mode)
      debug:
        msg: "Would create initial node annotation job from cronjob/label-and-annotate-nodes"
      when: ansible_check_mode

    - name: Wait for initial node annotation to complete
      shell: |
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml \
          wait --for=condition=complete --timeout=300s \
          job/label-and-annotate-nodes-initial -n default
      register: annotation_wait
      retries: 3
      delay: 10
      failed_when: false
      when: not ansible_check_mode and initial_job is defined and initial_job.rc == 0

    - name: Debug kubectl wait for job completion (check mode)
      debug:
        msg: "Would wait for initial node annotation job to complete"
      when: ansible_check_mode
      
    - name: Log Node Annotator success
      debug:
        msg: "Node annotator deployed and initial annotation completed for all cluster nodes"
      when: not ansible_check_mode and annotation_wait is defined and annotation_wait.rc == 0

    - name: Log Node Annotator warning
      debug:
        msg: "Node annotator deployed but initial annotation had issues - CronJob will retry every 5 minutes"
      when: not ansible_check_mode and annotation_wait is defined and annotation_wait.rc != 0

    - name: Debug Node Annotator completion (check mode)
      debug:
        msg: "Would complete Node Annotator deployment and trigger initial annotation for all cluster nodes"
      when: ansible_check_mode