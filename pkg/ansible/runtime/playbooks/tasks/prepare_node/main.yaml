---
# Node Preparation Main Orchestrator
# 
# Purpose: Orchestrates all node preparation tasks in proper sequence
# Scope: Runs package installation, system configuration, GPU setup, storage, and NTP
#
# Parameters:
#   GPU_NODE: Boolean indicating if this is a GPU node (default: false)
#   NO_DISKS_FOR_CLUSTER: Boolean to skip disk preparation (default: false)
#   CLUSTER_PREMOUNTED_DISKS: String indicating pre-mounted disk configuration
#   FIRST_NODE: Boolean indicating if this is the first node
#   SERVER_IP: IP address of the first node (for additional nodes)
#
# Returns: Succeeds when all node preparation is complete
#
# Usage:
#   include_tasks: tasks/prepare_node/main.yaml

- name: Install Dependencies
  tags: packages
  import_tasks: packages.yaml

- name: Setup Multipath
  tags: multipath
  import_tasks: multipath.yaml

- name: Setup and Check ROCm
  tags: gpu_rocm
  import_tasks: gpu_rocm.yaml
  when: GPU_NODE | bool

- name: Update Modprobe (GPU nodes)
  tags: gpu_modprobe
  import_tasks: gpu_modprobe.yaml
  when: GPU_NODE | bool

- name: Prepare Longhorn Disks
  tags: storage
  import_tasks: storage.yaml
  when: not NO_DISKS_FOR_CLUSTER | bool and CLUSTER_PREMOUNTED_DISKS == ""

- name: Configure System Settings
  tags: system_config
  import_tasks: system_config.yaml

- name: Update Udev Rules (GPU nodes)
  tags: gpu_udev
  import_tasks: gpu_udev.yaml
  when: GPU_NODE | bool

- name: Configure Logging
  tags: logging
  import_tasks: logging.yaml

- name: Configure NTP
  tags: ntp
  import_tasks: ntp.yaml

- name: Disable Numa Balancing
  tags: numa
  import_tasks: disable_numa_balancing.yaml