---
# Local-Path Storage Setup Tasks for Small Clusters  
# This file contains tasks for setting up local-path-provisioner for high-performance local storage

- name: Prepare Local Storage Paths
  block:
    - name: Process CLUSTER_DISKS string into disk list
      set_fact:
        cluster_disks_raw: "{{ CLUSTER_DISKS.split(',') | map('trim') | select('!=', '') | list }}"
      when: CLUSTER_DISKS is defined and CLUSTER_DISKS != ""

    - name: Build indexed mount paths for CLUSTER_DISKS (same as Longhorn)
      set_fact:
        local_path_dirs: "{{ range(cluster_disks_raw | length) | map('string') | map('regex_replace', '^(.*)$', '/mnt/disk\\1') | list }}"
      when: cluster_disks_raw is defined and cluster_disks_raw | length > 0

    - name: Build disk paths list from CLUSTER_PREMOUNTED_DISKS
      set_fact:
        local_path_dirs: "{{ CLUSTER_PREMOUNTED_DISKS.split(',') | map('trim') | select('!=', '') | unique | list }}"
      when: 
        - CLUSTER_PREMOUNTED_DISKS is defined 
        - CLUSTER_PREMOUNTED_DISKS != ""
        - local_path_dirs is not defined

    - name: Use default path if no disks configured
      set_fact:
        local_path_dirs: ["/opt/local-path-provisioner"]
      when: local_path_dirs is not defined

    - name: Create local storage directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      loop: "{{ local_path_dirs }}"

- name: Deploy Local-Path Provisioner
  block:
    - name: Copy static local-path manifests to RKE2
      copy:
        src: "manifests/local-path/{{ item }}"
        dest: "/var/lib/rancher/rke2/server/manifests/{{ item }}"
        mode: "0644"
      loop:
        - local-path-namespace.yaml
        - local-path-rbac.yaml
        - local-path-provisioner.yaml
        - local-path-storageclass.yaml

    - name: Get current node name for single-node configuration
      shell: |
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml \
          get nodes -o jsonpath='{.items[0].metadata.name}'
      register: current_node_name
      changed_when: false

    - name: Template local-path config manifest to RKE2
      template:
        src: "manifests/local-path/local-path-config.yaml"
        dest: "/var/lib/rancher/rke2/server/manifests/local-path-config.yaml"
        mode: "0644"
      vars:
        CLUSTER_DISK_PATHS: "{{ local_path_dirs }}"
        LOCAL_PATH_NODE_NAME: "{{ current_node_name.stdout }}"

    - name: Wait for local-path-provisioner deployment
      shell: |
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml \
          wait --for=condition=Available --timeout=300s \
          deployment/local-path-provisioner -n local-path-storage
      register: deployment_wait
      retries: 3
      delay: 10

- name: Validate Local-Path Storage with Test Pod
  block:
    - name: Create test PVC and Pod for local-path validation
      shell: |
        cat <<EOF | /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml apply -f -
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: storage-test-pvc
          namespace: default
        spec:
          accessModes:
            - ReadWriteOnce
          storageClassName: default
          resources:
            requests:
              storage: 1Gi
        ---
        apiVersion: v1
        kind: Pod
        metadata:
          name: storage-test-pod
          namespace: default
        spec:
          containers:
          - name: test-container
            image: ghcr.io/silogen/cluster-busybox:1.37.0
            command:
            - sh
            - -c
            - |
              echo "Testing local-path storage..." && 
              echo "$(date): Storage test initiated" > /test-volume/test-file.txt &&
              cat /test-volume/test-file.txt &&
              echo "Storage test successful!" &&
              sleep 30
            volumeMounts:
            - name: test-storage
              mountPath: /test-volume
          volumes:
          - name: test-storage
            persistentVolumeClaim:
              claimName: storage-test-pvc
          restartPolicy: Never
        EOF

    - name: Wait for Pod to start and PVC to be bound
      shell: |
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml \
          wait --for=condition=Ready pod/storage-test-pod --timeout=300s
      register: pod_ready
      retries: 3
      delay: 10

    - name: Check PVC binding status
      shell: |
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml \
          get pvc storage-test-pvc -o jsonpath='{.status.phase}'
      register: pvc_final_status

    - name: Get pod logs for verification
      shell: |
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml \
          logs storage-test-pod
      register: pod_logs
      ignore_errors: yes

    - name: Clean up test resources
      shell: |
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml \
          delete pod storage-test-pod --wait=false --ignore-not-found=true
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml \
          delete pvc storage-test-pvc --wait=false --ignore-not-found=true
      ignore_errors: yes

    - name: Log Local-Path validation results
      debug:
        msg: |
          Local-path storage validation completed:
          - PVC Status: {{ pvc_final_status.stdout }}
          - Pod Logs: {{ pod_logs.stdout_lines | default(['No logs available']) | join('\n  ') }}
          - Result: {{ 'SUCCESS' if pvc_final_status.stdout == 'Bound' else 'FAILED' }}