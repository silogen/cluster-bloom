---
# Rancher Partition Validation Tasks
# 
# Purpose: Validates /var/lib/rancher partition meets size requirements for GPU nodes
# Scope: Checks partition size and warns/fails if less than 500GB for GPU workloads
#
# Parameters:
#   GPU_NODE: Boolean indicating if this is a GPU node (default: false)
#   SKIP_RANCHER_PARTITION_CHECK: Boolean to bypass validation (default: false)
#
# Returns: Warns and fails if partition is less than 500GB on GPU nodes
#
# Usage:
#   include_tasks: tasks/validate_node/rancher_partition.yaml
#   when: GPU_NODE and not SKIP_RANCHER_PARTITION_CHECK

- name: Create /var/lib/rancher directory
  file:
    path: /var/lib/rancher
    state: directory
    mode: "0755"

- name: Get partition size
  shell: df -BG /var/lib/rancher | awk 'NR==2 {print $2}' | sed 's/G//'
  register: rancher_partition_size
  changed_when: false
  check_mode: false

- name: Warn if partition less than 500GB
  debug:
    msg: "WARNING: /var/lib/rancher partition is {{ rancher_partition_size.stdout }}GB, recommended 500GB for GPU nodes"
  when: rancher_partition_size.stdout | int < 500

- name: Fail if partition less than 500GB
  fail:
    msg: "/var/lib/rancher partition size ({{ rancher_partition_size.stdout }}GB) is less than recommended 500GB"
  when: rancher_partition_size.stdout | int < 500 and not ansible_check_mode

- name: Check mode warning for insufficient partition size
  debug:
    msg: "CHECK MODE: Would fail due to insufficient /var/lib/rancher partition size ({{ rancher_partition_size.stdout }}GB < 500GB recommended)"
  when: rancher_partition_size.stdout | int < 500 and ansible_check_mode